#!/bin/bash
# Desarrollado por Pablo Guerrero
# Para el amor de mi vida, mi Chalipanga. Sin ella no soy nada.
# Versión 1.1 Licencia GPL v 3.0
# Esta Script usa las herramientas wget y csvkit y herramientas estándar de Linux (grep,tee,echo,sed,bc)
#
### 1. Creación de variables
PRTGAUTH="username=pguerrero&passhash=115204423"
URLS="https://10.13.60.250/api/table.xml?content=sensors&columns=grpdev,sensor,objid,tags&filter_tags=@tag(PMI-Camara)&filter_type=ping&$PRTGAUTH&output=csvtable&count=99999999"
FechaInicio="2021-04-01-00-00-00"
FechaFin="2021-04-30-00-00-00"
s="==============================================="
prom=0;lines=0=promt=0
### 2. Descarga de sensores
wget --no-check-certificate -qO- $URLS|csvgrep -i -r 'Dashboard|dashboard' -c 7 > sensors.csv;SENSORS=sensors.csv
#### Clasificación
sumAnaliticasAGS=0; AnaliticasAGS=$(csvgrep -r "M-Aguascalientes" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasASN=0; AnaliticasASN=$(csvgrep -r "M-Asientos" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasCAL=0; AnaliticasCAL=$(csvgrep -r "M-Calvillo" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasCOS=0; AnaliticasCOS=$(csvgrep -r "M-Cosio" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasELL=0; AnaliticasELL=$(csvgrep -r "M-ElLlano" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasJSM=0; AnaliticasJSM=$(csvgrep -r "M-JesusMaria" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasPBA=0; AnaliticasPBA=$(csvgrep -r "M-Pabellon" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasRDR=0; AnaliticasRDR=$(csvgrep -r "M-Rincon" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasSFR=0; AnaliticasSFR=$(csvgrep -r "M-SanFrancisco" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasSJG=0; AnaliticasSJG=$(csvgrep -r "M-SanJose" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
sumAnaliticasTPZ=0; AnaliticasTPZ=$(csvgrep -r "M-Tepezala" -c 7 < $SENSORS|csvgrep -r "Analitica" -c 7 |csvcut -c 1,5 -K 1)
### 3. Consultor de disponibilidad de prtg
echo -e "PRTG Reportes de Disponibilidad de Cámaras Municipales\n$(date) \nbatts & z64 with ♥\n$s\n" |tee -a log 
# Descarga y procesamiento de datos, ser paciente
echo -e "Municipio de Asientos\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasASN.csv ; echo "$AnaliticasASN" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasASN=$(echo "$sumAnaliticasASN + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasASN"|tee -a AnaliticasASN.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasASN"|wc -l) ; promAnaliticasASN=$(echo "scale=4; $sumAnaliticasASN / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Calvillo\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasCAL.csv ; echo "$AnaliticasCAL" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasCAL=$(echo "$sumAnaliticasCAL + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasCAL"|tee -a AnaliticasCAL.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasCAL"|wc -l) ; promAnaliticasCAL=$(echo "scale=4; $sumAnaliticasCAL / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Cosío\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasCOS.csv ; echo "$AnaliticasCOS" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasCOS=$(echo "$sumAnaliticasCOS + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasCOS"|tee -a AnaliticasCOS.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasCOS"|wc -l) ; promAnaliticasCOS=$(echo "scale=4; $sumAnaliticasCOS / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de El Llano\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasELL.csv ; echo "$AnaliticasELL" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasELL=$(echo "$sumAnaliticasELL + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasELL"|tee -a AnaliticasELL.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasELL"|wc -l) ; promAnaliticasELL=$(echo "scale=4; $sumAnaliticasELL / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Jesús María\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasJSM.csv ; echo "$AnaliticasJSM" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasJSM=$(echo "$sumAnaliticasJSM + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasJSM"|tee -a AnaliticasJSM.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasJSM"|wc -l) ; promAnaliticasJSM=$(echo "scale=4; $sumAnaliticasJSM / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Pabellón\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasPBA.csv ; echo "$AnaliticasPBA" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasPBA=$(echo "$sumAnaliticasPBA + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasPBA"|tee -a AnaliticasPBA.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasPBA"|wc -l) ; promAnaliticasPBA=$(echo "scale=4; $sumAnaliticasPBA / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Rincón de Romos\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasRDR.csv ; echo "$AnaliticasRDR" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasRDR=$(echo "$sumAnaliticasRDR + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasRDR"|tee -a AnaliticasRDR.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasRDR"|wc -l) ; promAnaliticasRDR=$(echo "scale=4; $sumAnaliticasRDR / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de San Francisco de los Romo\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasSFR.csv ; echo "$AnaliticasSFR" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasSFR=$(echo "$sumAnaliticasSFR + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasSFR"|tee -a AnaliticasSFR.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasSFR"|wc -l) ; promAnaliticasSFR=$(echo "scale=4; $sumAnaliticasSFR / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de San José de Gracia\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasSJG.csv ; echo "$AnaliticasSJG" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasSJG=$(echo "$sumAnaliticasSJG + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasSJG"|tee -a AnaliticasSJG.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasSJG"|wc -l) ; promAnaliticasSJG=$(echo "scale=4; $sumAnaliticasSJG / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Tepezalá\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasTPZ.csv ; echo "$AnaliticasTPZ" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasTPZ=$(echo "$sumAnaliticasTPZ + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasTPZ"|tee -a AnaliticasTPZ.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasTPZ"|wc -l) ; promAnaliticasTPZ=$(echo "scale=4; $sumAnaliticasTPZ / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Aguascalientes\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee AnaliticasAGS.csv ; echo "$AnaliticasAGS" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumAnaliticasAGS=$(echo "$sumAnaliticasAGS + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumAnaliticasAGS"|tee -a AnaliticasAGS.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$AnaliticasAGS"|wc -l) ; promAnaliticasAGS=$(echo "scale=4; $sumAnaliticasAGS / $l"| bc) ; rm -rf tmp.csv
# Creación de archivo CSV de Promedios
touch PromediosAnaliticas.csv;p=PromediosAnaliticas.csv
echo -e "Aguascalientes,$promAnaliticasAGS" >> $p
echo -e "Asientos,$promAnaliticasASN" >> $p
echo -e "Calvillo,$promAnaliticasCAL" >> $p
echo -e "Cosío,$promAnaliticasCOS" >> $p
echo -e "El Llano,$promAnaliticasELL" >> $p
echo -e "Jesús María,$promAnaliticasJSM" >> $p
echo -e "Pabellón de Arteaga,$promAnaliticasPBA" >> $p
echo -e "Rincón de Romos,$promAnaliticasRDR" >> $p
echo -e "San Francisco de los Romo,$promAnaliticasSFR" >> $p
echo -e "San José de Gracia,$promAnaliticasSJG" >> $p
echo -e "Tepezalá,$promAnaliticasTPZ" >> $p
#Uso de Pyexcel para crear mega archivo con toda la información
pyexcel merge --output-file-type xls PromediosAnaliticas.csv Analiticas*.csv  Disponibilidad_Analiticas_Municipales.xls
echo -e "Proceso Finalizado\n$s$(date +%D-%T-Hrs)\n$s\nGracias por la Paciencia, desarrollado por Pablo Guerrero"

