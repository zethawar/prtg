#!/bin/bash
# Desarrollado por Pablo Guerrero
# Para el amor de mi vida, mi Chalipanga. Sin ella no soy nada.
# Versión 1.1 Licencia GPL v 3.0
# Esta Script usa las herramientas wget y csvkit y herramientas estándar de Linux (grep,tee,echo,sed,bc)
#
### 1. Creación de variables
PRTGAUTH="username=pguerrero&passhash=115204423"
URLS="https://10.13.60.250/api/table.xml?content=sensors&columns=grpdev,sensor,objid,tags&filter_tags=@tag(Switch)&filter_type=ping&$PRTGAUTH&output=csvtable&count=99999999"
FechaInicio="2021-04-01-00-00-00"
FechaFin="2021-04-30-00-00-00"
s="==============================================="
prom=0;lines=0=promt=0
### 2. Descarga de sensores
wget --no-check-certificate -qO- $URLS|csvgrep -i -r 'Dashboard|dashboard' -c 7 > sensors.csv;SENSORS=sensors.csv
#### Clasificación
sumSwitchesAGS=0; SwitchesAGS=$(csvgrep -r "M-Aguascalientes" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesASN=0; SwitchesASN=$(csvgrep -r "M-Asientos" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesCAL=0; SwitchesCAL=$(csvgrep -r "M-Calvillo" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesCOS=0; SwitchesCOS=$(csvgrep -r "M-Cosio" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesELL=0; SwitchesELL=$(csvgrep -r "M-ElLlano" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesJSM=0; SwitchesJSM=$(csvgrep -r "M-JesusMaria" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesPBA=0; SwitchesPBA=$(csvgrep -r "M-Pabellon" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesRDR=0; SwitchesRDR=$(csvgrep -r "M-Rincon" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesSFR=0; SwitchesSFR=$(csvgrep -r "M-SanFrancisco" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesSJG=0; SwitchesSJG=$(csvgrep -r "M-SanJose" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
sumSwitchesTPZ=0; SwitchesTPZ=$(csvgrep -r "M-Tepezala" -c 7 < $SENSORS|csvgrep -r "PMI-Switch" -c 7 |csvcut -c 1,5 -K 1)
### 3. Consultor de disponibilidad de prtg
echo -e "PRTG Reportes de Disponibilidad de Switches Municipales\n$(date) \nbatts & z64 with ♥\n$s\n" |tee -a log 
# Descarga y procesamiento de datos, ser paciente
echo -e "Municipio de Asientos\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesASN.csv ; echo "$SwitchesASN" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesASN=$(echo "$sumSwitchesASN + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesASN"|tee -a SwitchesASN.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesASN"|wc -l) ; promSwitchesASN=$(echo "scale=4; $sumSwitchesASN / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Calvillo\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesCAL.csv ; echo "$SwitchesCAL" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesCAL=$(echo "$sumSwitchesCAL + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesCAL"|tee -a SwitchesCAL.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesCAL"|wc -l) ; promSwitchesCAL=$(echo "scale=4; $sumSwitchesCAL / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Cosío\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesCOS.csv ; echo "$SwitchesCOS" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesCOS=$(echo "$sumSwitchesCOS + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesCOS"|tee -a SwitchesCOS.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesCOS"|wc -l) ; promSwitchesCOS=$(echo "scale=4; $sumSwitchesCOS / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de El Llano\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesELL.csv ; echo "$SwitchesELL" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesELL=$(echo "$sumSwitchesELL + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesELL"|tee -a SwitchesELL.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesELL"|wc -l) ; promSwitchesELL=$(echo "scale=4; $sumSwitchesELL / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Jesús María\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesJSM.csv ; echo "$SwitchesJSM" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesJSM=$(echo "$sumSwitchesJSM + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesJSM"|tee -a SwitchesJSM.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesJSM"|wc -l) ; promSwitchesJSM=$(echo "scale=4; $sumSwitchesJSM / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Pabellón\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesPBA.csv ; echo "$SwitchesPBA" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesPBA=$(echo "$sumSwitchesPBA + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesPBA"|tee -a SwitchesPBA.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesPBA"|wc -l) ; promSwitchesPBA=$(echo "scale=4; $sumSwitchesPBA / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Rincón de Romos\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesRDR.csv ; echo "$SwitchesRDR" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesRDR=$(echo "$sumSwitchesRDR + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesRDR"|tee -a SwitchesRDR.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesRDR"|wc -l) ; promSwitchesRDR=$(echo "scale=4; $sumSwitchesRDR / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de San Francisco de los Romo\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesSFR.csv ; echo "$SwitchesSFR" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesSFR=$(echo "$sumSwitchesSFR + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesSFR"|tee -a SwitchesSFR.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesSFR"|wc -l) ; promSwitchesSFR=$(echo "scale=4; $sumSwitchesSFR / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de San José de Gracia\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesSJG.csv ; echo "$SwitchesSJG" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesSJG=$(echo "$sumSwitchesSJG + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesSJG"|tee -a SwitchesSJG.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesSJG"|wc -l) ; promSwitchesSJG=$(echo "scale=4; $sumSwitchesSJG / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Tepezalá\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesTPZ.csv ; echo "$SwitchesTPZ" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesTPZ=$(echo "$sumSwitchesTPZ + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesTPZ"|tee -a SwitchesTPZ.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesTPZ"|wc -l) ; promSwitchesTPZ=$(echo "scale=4; $sumSwitchesTPZ / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Aguascalientes\n$s"|tee -a log ; echo "PMI\Switch,Disponibilidad,DispAcumulada" | tee -a log | tee SwitchesAGS.csv ; echo "$SwitchesAGS" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumSwitchesAGS=$(echo "$sumSwitchesAGS + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumSwitchesAGS"|tee -a SwitchesAGS.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$SwitchesAGS"|wc -l) ; promSwitchesAGS=$(echo "scale=4; $sumSwitchesAGS / $l"| bc) ; rm -rf tmp.csv
# Creación de archivo CSV de Promedios
touch PromediosSwitches.csv;p=PromediosSwitches.csv
echo -e "Aguascalientes,$promSwitchesAGS" >> $p
echo -e "Asientos,$promSwitchesASN" >> $p
echo -e "Calvillo,$promSwitchesCAL" >> $p
echo -e "Cosío,$promSwitchesCOS" >> $p
echo -e "El Llano,$promSwitchesELL" >> $p
echo -e "Jesús María,$promSwitchesJSM" >> $p
echo -e "Pabellón de Arteaga,$promSwitchesPBA" >> $p
echo -e "Rincón de Romos,$promSwitchesRDR" >> $p
echo -e "San Francisco de los Romo,$promSwitchesSFR" >> $p
echo -e "San José de Gracia,$promSwitchesSJG" >> $p
echo -e "Tepezalá,$promSwitchesTPZ" >> $p
#Uso de Pyexcel para crear mega archivo con toda la información
pyexcel merge --output-file-type xls PromediosSwitches.csv Switches*.csv  Disponibilidad_Switches_Municipales.xls
echo -e "Proceso Finalizado\n$s$(date +%D-%T-Hrs)\n$s\nGracias por la Paciencia, desarrollado por Pablo Guerrero"

