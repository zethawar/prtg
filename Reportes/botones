#!/bin/bash
# Desarrollado por Pablo Guerrero
# Para el amor de mi vida, mi Chalipanga. Sin ella no soy nada.
# Versión 1.1 Licencia GPL v 3.0
# Esta Script usa las herramientas wget y csvkit y herramientas estándar de Linux (grep,tee,echo,sed,bc)
#
### 1. Creación de variables
PRTGAUTH="username=pguerrero&passhash=115204423"
URLS="https://10.13.60.250/api/table.xml?content=sensors&columns=grpdev,sensor,objid,tags&filter_tags=@tag(Boton)&filter_type=ping&$PRTGAUTH&output=csvtable&count=99999999"
FechaInicio="2021-04-01-00-00-00"
FechaFin="2021-04-30-00-00-00"
s="==============================================="
prom=0;lines=0=promt=0
### 2. Descarga de sensores
wget --no-check-certificate -qO- $URLS|csvgrep -i -r 'Dashboard|dashboard' -c 7 > sensors.csv;SENSORS=sensors.csv
#### Clasificación
sumBotonesAGS=0; BotonesAGS=$(csvgrep -r "M-Aguascalientes" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesASN=0; BotonesASN=$(csvgrep -r "M-Asientos" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesCAL=0; BotonesCAL=$(csvgrep -r "M-Calvillo" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesCOS=0; BotonesCOS=$(csvgrep -r "M-Cosio" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesELL=0; BotonesELL=$(csvgrep -r "M-ElLlano" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesJSM=0; BotonesJSM=$(csvgrep -r "M-JesusMaria" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesPBA=0; BotonesPBA=$(csvgrep -r "M-Pabellon" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesRDR=0; BotonesRDR=$(csvgrep -r "M-Rincon" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesSFR=0; BotonesSFR=$(csvgrep -r "M-SanFrancisco" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesSJG=0; BotonesSJG=$(csvgrep -r "M-SanJose" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
sumBotonesTPZ=0; BotonesTPZ=$(csvgrep -r "M-Tepezala" -c 7 < $SENSORS|csvgrep -r "Boton" -c 7 |csvcut -c 1,5 -K 1)
### 3. Consultor de disponibilidad de prtg
echo -e "PRTG Reportes de Disponibilidad de Botones Municipales\n$(date) \nbatts & z64 with ♥\n$s\n" |tee -a log 
# Descarga y procesamiento de datos, ser paciente
echo -e "Municipio de Asientos\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesASN.csv ; echo "$BotonesASN" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesASN=$(echo "$sumBotonesASN + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesASN"|tee -a BotonesASN.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesASN"|wc -l) ; promBotonesASN=$(echo "scale=4; $sumBotonesASN / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Calvillo\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesCAL.csv ; echo "$BotonesCAL" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesCAL=$(echo "$sumBotonesCAL + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesCAL"|tee -a BotonesCAL.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesCAL"|wc -l) ; promBotonesCAL=$(echo "scale=4; $sumBotonesCAL / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Cosío\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesCOS.csv ; echo "$BotonesCOS" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesCOS=$(echo "$sumBotonesCOS + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesCOS"|tee -a BotonesCOS.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesCOS"|wc -l) ; promBotonesCOS=$(echo "scale=4; $sumBotonesCOS / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de El Llano\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesELL.csv ; echo "$BotonesELL" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesELL=$(echo "$sumBotonesELL + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesELL"|tee -a BotonesELL.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesELL"|wc -l) ; promBotonesELL=$(echo "scale=4; $sumBotonesELL / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Jesús María\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesJSM.csv ; echo "$BotonesJSM" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesJSM=$(echo "$sumBotonesJSM + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesJSM"|tee -a BotonesJSM.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesJSM"|wc -l) ; promBotonesJSM=$(echo "scale=4; $sumBotonesJSM / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Pabellón\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesPBA.csv ; echo "$BotonesPBA" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesPBA=$(echo "$sumBotonesPBA + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesPBA"|tee -a BotonesPBA.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesPBA"|wc -l) ; promBotonesPBA=$(echo "scale=4; $sumBotonesPBA / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Rincón de Romos\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesRDR.csv ; echo "$BotonesRDR" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesRDR=$(echo "$sumBotonesRDR + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesRDR"|tee -a BotonesRDR.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesRDR"|wc -l) ; promBotonesRDR=$(echo "scale=4; $sumBotonesRDR / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de San Francisco de los Romo\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesSFR.csv ; echo "$BotonesSFR" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesSFR=$(echo "$sumBotonesSFR + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesSFR"|tee -a BotonesSFR.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesSFR"|wc -l) ; promBotonesSFR=$(echo "scale=4; $sumBotonesSFR / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de San José de Gracia\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesSJG.csv ; echo "$BotonesSJG" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesSJG=$(echo "$sumBotonesSJG + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesSJG"|tee -a BotonesSJG.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesSJG"|wc -l) ; promBotonesSJG=$(echo "scale=4; $sumBotonesSJG / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Tepezalá\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesTPZ.csv ; echo "$BotonesTPZ" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesTPZ=$(echo "$sumBotonesTPZ + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesTPZ"|tee -a BotonesTPZ.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesTPZ"|wc -l) ; promBotonesTPZ=$(echo "scale=4; $sumBotonesTPZ / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Aguascalientes\n$s"|tee -a log ; echo "PMI\Boton,Disponibilidad,DispAcumulada" | tee -a log | tee BotonesAGS.csv ; echo "$BotonesAGS" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumBotonesAGS=$(echo "$sumBotonesAGS + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumBotonesAGS"|tee -a BotonesAGS.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$BotonesAGS"|wc -l) ; promBotonesAGS=$(echo "scale=4; $sumBotonesAGS / $l"| bc) ; rm -rf tmp.csv
# Creación de archivo CSV de Promedios
touch PromediosBotones.csv;p=PromediosBotones.csv
echo -e "Aguascalientes,$promBotonesAGS" >> $p
echo -e "Asientos,$promBotonesASN" >> $p
echo -e "Calvillo,$promBotonesCAL" >> $p
echo -e "Cosío,$promBotonesCOS" >> $p
echo -e "El Llano,$promBotonesELL" >> $p
echo -e "Jesús María,$promBotonesJSM" >> $p
echo -e "Pabellón de Arteaga,$promBotonesPBA" >> $p
echo -e "Rincón de Romos,$promBotonesRDR" >> $p
echo -e "San Francisco de los Romo,$promBotonesSFR" >> $p
echo -e "San José de Gracia,$promBotonesSJG" >> $p
echo -e "Tepezalá,$promBotonesTPZ" >> $p
#Uso de Pyexcel para crear mega archivo con toda la información
pyexcel merge --output-file-type xls PromediosBotones.csv Botones*.csv  Disponibilidad_Botones_Municipales.xls
echo -e "Proceso Finalizado\n$s$(date +%D-%T-Hrs)\n$s\nGracias por la Paciencia, desarrollado por Pablo Guerrero"

