#!/bin/bash
# Desarrollado por Pablo Guerrero
# Para el amor de mi vida, mi Chalipanga. Sin ella no soy nada.
# Versión 1.1 Licencia GPL v 3.0
# Esta Script usa las herramientas wget y csvkit y herramientas estándar de Linux (grep,tee,echo,sed,bc)
#
### 1. Creación de variables
PRTGAUTH="username=pguerrero&passhash=115204423"
URLS="https://10.13.60.250/api/table.xml?content=sensors&columns=grpdev,sensor,objid,tags&filter_tags=@tag(PMI-Camara)&filter_type=ping&$PRTGAUTH&output=csvtable&count=99999999"
FechaInicio="2021-04-01-00-00-00"
FechaFin="2021-04-30-00-00-00"
s="==============================================="
prom=0;lines=0=promt=0
### 2. Descarga de sensores
wget --no-check-certificate -qO- $URLS|csvgrep -i -r 'Dashboard|dashboard' -c 7 > sensors.csv;SENSORS=sensors.csv
#### Clasificación
sumFijasAGS=0; FijasAGS=$(csvgrep -r "M-Aguascalientes" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasASN=0; FijasASN=$(csvgrep -r "M-Asientos" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasCAL=0; FijasCAL=$(csvgrep -r "M-Calvillo" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasCOS=0; FijasCOS=$(csvgrep -r "M-Cosio" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasELL=0; FijasELL=$(csvgrep -r "M-ElLlano" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasJSM=0; FijasJSM=$(csvgrep -r "M-JesusMaria" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasPBA=0; FijasPBA=$(csvgrep -r "M-Pabellon" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasRDR=0; FijasRDR=$(csvgrep -r "M-Rincon" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasSFR=0; FijasSFR=$(csvgrep -r "M-SanFrancisco" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasSJG=0; FijasSJG=$(csvgrep -r "M-SanJose" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
sumFijasTPZ=0; FijasTPZ=$(csvgrep -r "M-Tepezala" -c 7 < $SENSORS|csvgrep -r "Fija" -c 7 |csvcut -c 1,5 -K 1)
### 3. Consultor de disponibilidad de prtg
echo -e "PRTG Reportes de Disponibilidad de Cámaras Municipales\n$(date) \nbatts & z64 with ♥\n$s\n" |tee -a log 
# Descarga y procesamiento de datos, ser paciente
echo -e "Municipio de Asientos\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasASN.csv ; echo "$FijasASN" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasASN=$(echo "$sumFijasASN + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasASN"|tee -a FijasASN.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasASN"|wc -l) ; promFijasASN=$(echo "scale=4; $sumFijasASN / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Calvillo\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasCAL.csv ; echo "$FijasCAL" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasCAL=$(echo "$sumFijasCAL + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasCAL"|tee -a FijasCAL.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasCAL"|wc -l) ; promFijasCAL=$(echo "scale=4; $sumFijasCAL / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Cosío\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasCOS.csv ; echo "$FijasCOS" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasCOS=$(echo "$sumFijasCOS + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasCOS"|tee -a FijasCOS.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasCOS"|wc -l) ; promFijasCOS=$(echo "scale=4; $sumFijasCOS / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de El Llano\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasELL.csv ; echo "$FijasELL" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasELL=$(echo "$sumFijasELL + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasELL"|tee -a FijasELL.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasELL"|wc -l) ; promFijasELL=$(echo "scale=4; $sumFijasELL / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Jesús María\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasJSM.csv ; echo "$FijasJSM" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasJSM=$(echo "$sumFijasJSM + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasJSM"|tee -a FijasJSM.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasJSM"|wc -l) ; promFijasJSM=$(echo "scale=4; $sumFijasJSM / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Pabellón\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasPBA.csv ; echo "$FijasPBA" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasPBA=$(echo "$sumFijasPBA + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasPBA"|tee -a FijasPBA.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasPBA"|wc -l) ; promFijasPBA=$(echo "scale=4; $sumFijasPBA / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Rincón de Romos\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasRDR.csv ; echo "$FijasRDR" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasRDR=$(echo "$sumFijasRDR + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasRDR"|tee -a FijasRDR.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasRDR"|wc -l) ; promFijasRDR=$(echo "scale=4; $sumFijasRDR / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de San Francisco de los Romo\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasSFR.csv ; echo "$FijasSFR" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasSFR=$(echo "$sumFijasSFR + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasSFR"|tee -a FijasSFR.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasSFR"|wc -l) ; promFijasSFR=$(echo "scale=4; $sumFijasSFR / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de San José de Gracia\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasSJG.csv ; echo "$FijasSJG" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasSJG=$(echo "$sumFijasSJG + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasSJG"|tee -a FijasSJG.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasSJG"|wc -l) ; promFijasSJG=$(echo "scale=4; $sumFijasSJG / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Tepezalá\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasTPZ.csv ; echo "$FijasTPZ" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasTPZ=$(echo "$sumFijasTPZ + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasTPZ"|tee -a FijasTPZ.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasTPZ"|wc -l) ; promFijasTPZ=$(echo "scale=4; $sumFijasTPZ / $l"| bc) ; rm -rf tmp.csv
echo -e "Municipio de Aguascalientes\n$s"|tee -a log ; echo "PMI\Camara,Disponibilidad,DispAcumulada" | tee -a log | tee FijasAGS.csv ; echo "$FijasAGS" > tmp.csv; while IFS=',' read nombre id; do data=$(wget --no-check-certificate -qO- "https://10.13.60.250/api/historicdata.csv?id=$id&avg=3600&sdate=$FechaInicio&edate=$FechaFin&$PRTGAUTH"|csvcut -c 13 -K 1|sed 's/ %//g') ; echo "$data" > data.csv; while IFS=',' read av ; do sum=$((sum+av)) ; done < data.csv ; lines=$(echo "$data" |wc -l) ; prom=$(echo "scale=4; $sum / $lines"|bc) ; sumFijasAGS=$(echo "$sumFijasAGS + $prom"|bc) ; echo -n -e "\n$nombre,$prom,$sumFijasAGS"|tee -a FijasAGS.csv|tee -a log ;sum=0;prom=0;lines=0; done < tmp.csv; l=$(echo "$FijasAGS"|wc -l) ; promFijasAGS=$(echo "scale=4; $sumFijasAGS / $l"| bc) ; rm -rf tmp.csv
# Creación de archivo CSV de Promedios
touch Promedios.csv;p=Promedios.csv
echo -e "Aguascalientes,$promFijasAGS" >> $p
echo -e "Asientos,$promFijasASN" >> $p
echo -e "Calvillo,$promFijasCAL" >> $p
echo -e "Cosío,$promFijasCOS" >> $p
echo -e "El Llano,$promFijasELL" >> $p
echo -e "Jesús María,$promFijasJSM" >> $p
echo -e "Pabellón de Arteaga,$promFijasPBA" >> $p
echo -e "Rincón de Romos,$promFijasRDR" >> $p
echo -e "San Francisco de los Romo,$promFijasSFR" >> $p
echo -e "San José de Gracia,$promFijasSJG" >> $p
echo -e "Tepezalá,$promFijasTPZ" >> $p
#Uso de Pyexcel para crear mega archivo con toda la información
pyexcel merge --output-file-type xls Promedios.csv Fijas*.csv  Disponibilidad_Fijas_Municipales.xls
echo -e "Proceso Finalizado\n$s$(date +%D-%T-Hrs)\n$s\nGracias por la Paciencia, desarrollado por Pablo Guerrero"

